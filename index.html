<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Gerenciamento de Escala</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <style>
    body { font-family: Arial; padding: 20px; }
    label { display: block; margin-top: 10px; }
    select, input, button { margin-bottom: 10px; width: 300px; }
    .section { border: 1px solid #ccc; padding: 15px; margin-bottom: 30px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 5px; text-align: left; }
  </style>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAwK935g0qeR4Lhbn_eTgXwkbongPp4QYU",
      authDomain: "coletor-92990.firebaseapp.com",
      databaseURL: "https://coletor-92990-default-rtdb.firebaseio.com",
      projectId: "coletor-92990",
      storageBucket: "coletor-92990.firebasestorage.app",
      messagingSenderId: "591970302569",
      appId: "1:591970302569:web:edcf8e8c6f55729c9340f8",
      measurementId: "G-QJQNMDCHW5"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let mapaPublicadores = {};
    let mapaEquipamentos = {};
    let mapaPontos = {};

    function adicionarEntrada(caminho, dados) {
      db.ref(caminho).push(dados);
    }

    function atualizarEntrada(caminho, id, dados) {
      db.ref(`${caminho}/${id}`).set(dados);
    }

    function excluirEntrada(caminho, id) {
      db.ref(`${caminho}/${id}`).remove();
    }

    function carregarOpcoes(caminho, selectId) {
      db.ref(caminho).once('value').then(snapshot => {
        const select = document.getElementById(selectId);
        if (!select) return;
        select.innerHTML = '<option value="">Selecione</option>';
        snapshot.forEach(child => {
          const val = child.val();
          let texto = "";
          if (caminho === 'Publicadores' && val.Publicador) texto = val.Publicador;
          else if (caminho === 'Equipamentos' && val.Equipamentos) texto = val.Equipamentos;
          else if (caminho === 'Pontos' && val["Nome do ponto"]) texto = val["Nome do ponto"];
          else texto = "Sem nome";

          const option = document.createElement("option");
          option.value = texto;
          option.textContent = texto;
          select.appendChild(option);

          // Guardar os nomes completos em mapas
          if (caminho === 'Publicadores') mapaPublicadores[texto] = texto;
          if (caminho === 'Equipamentos') mapaEquipamentos[texto] = texto;
          if (caminho === 'Pontos') mapaPontos[texto] = texto;
        });
      });
    }

    function salvarEscala() {
      const dados = {
        ponto: document.getElementById('ponto').value,
        equipamento: document.getElementById('equipamento').value,
        publicadores: ["p1", "p2", "p3"].map(id => document.getElementById(id).value).filter(Boolean),
        inicio: document.getElementById('inicio').value,
        fim: document.getElementById('fim').value
      };
      adicionarEntrada('escalas', dados);
      alert("Escala salva com sucesso!");
      listarEscalas();
    }

    function listarEscalas() {
      const tbody = document.getElementById("lista-escalas");
      tbody.innerHTML = "";
      db.ref('escalas').once('value').then(snapshot => {
        snapshot.forEach(child => {
          const esc = child.val();
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${esc.ponto}</td>
            <td>${esc.equipamento}</td>
            <td>${(esc.publicadores || []).join(', ')}</td>
            <td>${esc.inicio}</td>
            <td>${esc.fim}</td>
            <td><button onclick="excluirEntrada('escalas','${child.key}');listarEscalas()">Excluir</button></td>
          `;
          tbody.appendChild(row);
        });
      });
    }

    function adicionarSimples(caminho, inputId) {
      const valor = document.getElementById(inputId).value;
      if (!valor) return;
      const dados = {};
      dados[caminho === 'Pontos' ? "Nome do ponto" : caminho.slice(0, -1)] = valor;
      adicionarEntrada(caminho, dados);
      alert("Adicionado com sucesso!");
      document.getElementById(inputId).value = "";
      carregarOpcoes(caminho, caminho === 'Publicadores' ? 'p1' : caminho === 'Equipamentos' ? 'equipamento' : 'ponto');
    }

    window.onload = () => {
      ["p1", "p2", "p3"].forEach(id => carregarOpcoes('Publicadores', id));
      carregarOpcoes('Equipamentos', 'equipamento');
      carregarOpcoes('Pontos', 'ponto');
      listarEscalas();
    }
  </script>
</head>
<body>
  <h1>Gerenciamento de Escalas</h1>

  <div class="section">
    <h2>Nova Escala</h2>
    <label>Ponto:</label>
    <select id="ponto"></select>
    <label>Equipamento:</label>
    <select id="equipamento"></select>
    <label>Publicador 1:</label>
    <select id="p1"></select>
    <label>Publicador 2:</label>
    <select id="p2"></select>
    <label>Publicador 3:</label>
    <select id="p3"></select>
    <label>Início:</label>
    <input type="time" id="inicio">
    <label>Fim:</label>
    <input type="time" id="fim"><br>
    <button onclick="salvarEscala()">Salvar Escala</button>
  </div>

  <div class="section">
    <h2>Escalas Cadastradas</h2>
    <table>
      <thead>
        <tr>
          <th>Ponto</th>
          <th>Equipamento</th>
          <th>Publicadores</th>
          <th>Início</th>
          <th>Fim</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody id="lista-escalas"></tbody>
    </table>
  </div>

  <div class="section">
    <h2>Manutenção Tabelas</h2>
    <label>Novo Publicador:</label>
    <input id="novoPublicador">
    <button onclick="adicionarSimples('Publicadores', 'novoPublicador')">Adicionar</button><br>

    <label>Novo Equipamento:</label>
    <input id="novoEquipamento">
    <button onclick="adicionarSimples('Equipamentos', 'novoEquipamento')">Adicionar</button><br>

    <label>Novo Ponto:</label>
    <input id="novoPonto">
    <button onclick="adicionarSimples('Pontos', 'novoPonto')">Adicionar</button><br>
  </div>
</body>
</html>
