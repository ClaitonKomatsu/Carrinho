<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Gerenciamento de Escala</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <style>
    body { font-family: Arial; padding: 20px; }
    label { display: block; margin-top: 10px; }
    select, input, button { margin-bottom: 10px; width: 300px; }
    .section { border: 1px solid #ccc; padding: 15px; margin-bottom: 30px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 5px; text-align: left; }
    .inline { display: inline-block; margin-right: 10px; vertical-align: top; }
    .edit-input { width: 200px; }
  </style>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAwK935g0qeR4Lhbn_eTgXwkbongPp4QYU",
      authDomain: "coletor-92990.firebaseapp.com",
      databaseURL: "https://coletor-92990-default-rtdb.firebaseio.com",
      projectId: "coletor-92990",
      storageBucket: "coletor-92990.firebasestorage.app",
      messagingSenderId: "591970302569",
      appId: "1:591970302569:web:edcf8e8c6f55729c9340f8",
      measurementId: "G-QJQNMDCHW5"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function carregarOpcoes(caminho, selectId) {
      db.ref(caminho).once('value').then(snapshot => {
        const select = document.getElementById(selectId);
        if (!select) return;
        select.innerHTML = '<option value="">Selecione</option>';
        snapshot.forEach(child => {
          const val = child.val();
          let texto = val["Nome do ponto"] || val.Publicador || val.Equipamentos || val.nome || "Sem nome";
          const option = document.createElement("option");
          option.value = texto;
          option.textContent = texto;
          select.appendChild(option);
        });
      });
    }

    function salvarEscala() {
      const inicio = document.getElementById('inicio').value;
      const fim = document.getElementById('fim').value;
      if (fim <= inicio) {
        alert("O horário FIM deve ser maior que o horário INÍCIO.");
        return;
      }
      const dados = {
        ponto: document.getElementById('ponto').value,
        equipamento: document.getElementById('equipamento').value,
        publicadores: ["p1", "p2", "p3"].map(id => document.getElementById(id).value).filter(Boolean),
        inicio,
        fim
      };
      db.ref('escalas').push(dados);
      alert("Escala salva com sucesso!");
      listarEscalas();
    }

    function listarEscalas() {
      const filtroNome = document.getElementById("filtro")?.value?.toLowerCase() || "";
      const filtroPonto = document.getElementById("filtroPonto")?.value?.toLowerCase() || "";
      const filtroData = document.getElementById("filtroData")?.value || "";

      const tbody = document.getElementById("lista-escalas");
      tbody.innerHTML = "";
      db.ref('escalas').once('value').then(snapshot => {
        snapshot.forEach(child => {
          const esc = child.val();
          if (filtroNome && !esc.publicadores?.some(p => p.toLowerCase().includes(filtroNome))) return;
          if (filtroPonto && !(esc.ponto || "").toLowerCase().includes(filtroPonto)) return;
          if (filtroData && !(esc.inicio || "").startsWith(filtroData)) return;

          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${esc.ponto}</td>
            <td>${esc.equipamento}</td>
            <td>${(esc.publicadores || []).join(', ')}</td>
            <td>${esc.inicio}</td>
            <td>${esc.fim}</td>
            <td><button onclick="excluirEntrada('escalas','${child.key}');listarEscalas()">Excluir</button></td>
          `;
          tbody.appendChild(row);
        });
      });
    }

    function excluirEntrada(caminho, id) {
      db.ref(`${caminho}/${id}`).remove();
    }

    function atualizarEntrada(caminho, id, campo, valor) {
      db.ref(`${caminho}/${id}`).update({ [campo]: valor });
    }

    function listarTabela(caminho, campo, tbodyId) {
      const tbody = document.getElementById(tbodyId);
      tbody.innerHTML = "";
      db.ref(caminho).once('value').then(snapshot => {
        snapshot.forEach(child => {
          const val = child.val();
          const nome = val[campo] || "Sem nome";
          const inputId = `${tbodyId}_${child.key}`;
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td><input id="${inputId}" class="edit-input" value="${nome}"></td>
            <td>
              <button onclick="atualizarEntrada('${caminho}', '${child.key}', '${campo}', document.getElementById('${inputId}').value);listarTabela('${caminho}', '${campo}', '${tbodyId}')">Salvar</button>
              <button onclick="excluirEntrada('${caminho}', '${child.key}');listarTabela('${caminho}', '${campo}', '${tbodyId}');initSelects()">Excluir</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      });
    }

    function adicionarSimples(caminho, inputId) {
      const valor = document.getElementById(inputId).value;
      if (!valor) return;
      const dados = {};
      dados[caminho === 'Pontos' ? "Nome do ponto" : caminho === 'Equipamentos' ? "Equipamentos" : "Publicador"] = valor;
      db.ref(caminho).push(dados);
      alert("Adicionado com sucesso!");
      document.getElementById(inputId).value = "";
      initSelects();
    }

    function initSelects() {
      ["p1", "p2", "p3"].forEach(id => carregarOpcoes('Publicadores', id));
      carregarOpcoes('Equipamentos', 'equipamento');
      carregarOpcoes('Pontos', 'ponto');
    }

    window.onload = () => {
      initSelects();
      listarEscalas();
      listarTabela('Publicadores', 'Publicador', 'tabela-publicadores');
      listarTabela('Equipamentos', 'Equipamentos', 'tabela-equipamentos');
      listarTabela('Pontos', 'Nome do ponto', 'tabela-pontos');
    }
  </script>
</head>
<body>
  <h1>Gerenciamento de Escalas</h1>

  <div class="section">
    <h2>Nova Escala</h2>
    <label>Ponto:</label>
    <select id="ponto"></select>
    <label>Equipamento:</label>
    <select id="equipamento"></select>
    <label>Publicador 1:</label>
    <select id="p1"></select>
    <label>Publicador 2:</label>
    <select id="p2"></select>
    <label>Publicador 3:</label>
    <select id="p3"></select>
    <label>Início:</label>
    <input type="time" id="inicio">
    <label>Fim:</label>
    <input type="time" id="fim"><br>
    <button onclick="salvarEscala()">Salvar Escala</button>
  </div>

  <div class="section">
    <h2>Filtrar Escalas</h2>
    <input id="filtro" placeholder="Nome do publicador">
    <input id="filtroPonto" placeholder="Nome do ponto">
    <input id="filtroData" placeholder="Horário de início (hh:mm)">
    <button onclick="listarEscalas()">Filtrar</button>
  </div>

  <div class="section">
    <h2>Escalas Cadastradas</h2>
    <table>
      <thead>
        <tr>
          <th>Ponto</th>
          <th>Equipamento</th>
          <th>Publicadores</th>
          <th>Início</th>
          <th>Fim</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody id="lista-escalas"></tbody>
    </table>
  </div>

  <div class="section">
    <h2>Manutenção de Tabelas</h2>
    <div class="inline">
      <h3>Publicadores</h3>
      <input id="novoPublicador">
      <button onclick="adicionarSimples('Publicadores', 'novoPublicador')">Adicionar</button>
      <table><tbody id="tabela-publicadores"></tbody></table>
    </div>
    <div class="inline">
      <h3>Equipamentos</h3>
      <input id="novoEquipamento">
      <button onclick="adicionarSimples('Equipamentos', 'novoEquipamento')">Adicionar</button>
      <table><tbody id="tabela-equipamentos"></tbody></table>
    </div>
    <div class="inline">
      <h3>Pontos</h3>
      <input id="novoPonto">
      <button onclick="adicionarSimples('Pontos', 'novoPonto')">Adicionar</button>
      <table><tbody id="tabela-pontos"></tbody></table>
    </div>
  </div>
</body>
</html>
