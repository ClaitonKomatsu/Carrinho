<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciamento de Escala</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <style>
        :root {
            --primary-color: #007bff; --secondary-color: #6c757d; --success-color: #28a745;
            --warning-color: #ffc107; --danger-color: #dc3545; --light-color: #f8f9fa;
            --dark-color: #343a40; --text-color: #333; --border-color: #dee2e6;
            --shadow: 0 4px 8px rgba(0,0,0,0.1); --border-radius: 8px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Roboto', sans-serif; background-color: #f4f7f9; color: var(--text-color); line-height: 1.6; }
        .container { max-width: 1200px; margin: 20px auto; padding: 0 20px; }
        h1, h2, h3 { margin-bottom: 1rem; color: var(--dark-color); font-weight: 500; }
        h1 { text-align: center; margin-bottom: 2rem; font-weight: 700; }
        .section { background: #fff; padding: 25px; margin-bottom: 30px; border-radius: var(--border-radius); box-shadow: var(--shadow); border: 1px solid var(--border-color); }
        label { display: block; margin-bottom: 5px; font-weight: 500; }
        input[type="text"], input[type="date"], input[type="datetime-local"], select {
            width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid var(--border-color);
            border-radius: var(--border-radius); font-size: 1rem; transition: border-color 0.2s, box-shadow 0.2s;
        }
        select:focus, input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25); }
        .btn { display: inline-block; padding: 12px 20px; font-size: 1rem; font-weight: 500; text-align: center;
            border-radius: var(--border-radius); border: none; cursor: pointer; transition: all 0.2s; color: #fff;
        }
        .btn:hover { opacity: 0.9; }
        .btn:active { transform: translateY(1px); }
        .btn-primary { background-color: var(--primary-color); }
        .btn-success { background-color: var(--success-color); }
        .btn-danger { background-color: var(--danger-color); }
        .btn-secondary { background-color: var(--secondary-color); }
        .btn-sm { padding: 6px 12px; font-size: 0.875rem; }
        .filter-container { display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap; }
        .filter-container div { flex: 1; min-width: 200px; }
        .filter-container .btn { margin-bottom: 15px; height: 50px; }
        .maintenance-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; }
        .maintenance-item input[type="text"] { width: calc(100% - 100px); display: inline-block; margin-right: 10px; }
        .maintenance-item .btn-sm { width: 85px; vertical-align: top; padding: 12px 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid var(--border-color); padding: 12px; text-align: left; vertical-align: middle; }
        thead { background-color: var(--light-color); }
        tbody tr:nth-child(even) { background-color: #f9f9f9; }
        td .btn { margin-right: 5px; }
        .confirm-btns { display: flex; gap: 5px; align-items: center; }
        .confirm-btns button { width: 30px; height: 30px; border: none; border-radius: 50%; cursor: pointer; color: white;
            font-size: 16px; line-height: 30px; text-align: center; opacity: 0.4; transition: opacity 0.2s, transform 0.2s;
        }
        .confirm-btns button.active { opacity: 1; transform: scale(1.1); }
        .status-container > div { display: flex; align-items: center; justify-content: space-between; padding: 4px 0; }
        .verde { background: var(--success-color); }
        .amarelo { background: var(--warning-color); }
        .vermelho { background: var(--danger-color); }
        .form-actions { display: flex; gap: 10px; }
        @media (max-width: 768px) { .filter-container .btn { width: 100%; margin-bottom: 0; } }
    </style>
</head>
<body>
    <div class="container">
        <h1>Gerenciamento de Escalas üóìÔ∏è</h1>

        <div class="section">
            <h2 id="form-title">Nova Escala</h2>
            <form id="form-escala">
                <label for="ponto">Ponto:</label> <select id="ponto"></select>
                <label for="equipamento">Equipamento:</label> <select id="equipamento"></select>
                <label for="p1">Publicador 1:</label> <select id="p1"></select>
                <label for="p2">Publicador 2:</label> <select id="p2"></select>
                <label for="p3">Publicador 3:</label> <select id="p3"></select>
                <label for="inicio">In√≠cio:</label> <input type="datetime-local" id="inicio" step="900">
                <label for="fim">Fim:</label> <input type="datetime-local" id="fim" step="900">
                <div class="form-actions">
                    <button type="button" id="saveButton" class="btn btn-primary" onclick="salvarEscala()">Salvar Escala</button>
                    <button type="button" id="cancelButton" class="btn btn-secondary" onclick="cancelarEdicao()" style="display: none;">Cancelar</button>
                </div>
            </form>
        </div>

        <div class="section">
            <h2>Filtrar Escalas üîé</h2>
            <div class="filter-container">
                <div><label>Publicador:</label><input id="filtro" type="text" placeholder="Nome do publicador"></div>
                <div><label>Ponto:</label><input id="filtroPonto" type="text" placeholder="Nome do ponto"></div>
                <div><label>Data:</label><input id="filtroData" type="date"></div>
                <button class="btn btn-secondary" onclick="listarEscalas()">Filtrar</button>
            </div>
        </div>

        <div class="section">
            <h2>Escalas Cadastradas</h2>
            <div style="overflow-x:auto;">
                <table>
                    <thead>
                        <tr>
                            <th>Ponto</th><th>Equipamento</th><th>Publicadores / Status</th><th>In√≠cio</th><th>Fim</th><th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="lista-escalas"></tbody>
                </table>
            </div>
        </div>

        <div class="section">
            <h2>Manuten√ß√£o de Tabelas ‚öôÔ∏è</h2>
            <div class="maintenance-grid">
                <div class="maintenance-item">
                    <h3>Publicadores</h3>
                    <input id="novoPublicador" type="text" placeholder="Adicionar...">
                    <button class="btn btn-sm btn-success" onclick="adicionarSimples('Publicadores', 'novoPublicador')">Adicionar</button>
                    <table><tbody id="tabela-publicadores"></tbody></table>
                </div>
                <div class="maintenance-item">
                    <h3>Equipamentos</h3>
                    <input id="novoEquipamento" type="text" placeholder="Adicionar...">
                    <button class="btn btn-sm btn-success" onclick="adicionarSimples('Equipamentos', 'novoEquipamento')">Adicionar</button>
                    <table><tbody id="tabela-equipamentos"></tbody></table>
                </div>
                <div class="maintenance-item">
                    <h3>Pontos</h3>
                    <input id="novoPonto" type="text" placeholder="Adicionar...">
                    <button class="btn btn-sm btn-success" onclick="adicionarSimples('Pontos', 'novoPonto')">Adicionar</button>
                    <table><tbody id="tabela-pontos"></tbody></table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAwK935g0qeR4Lhbn_eTgXwkbongPp4QYU", authDomain: "coletor-92990.firebaseapp.com",
            databaseURL: "https://coletor-92990-default-rtdb.firebaseio.com", projectId: "coletor-92990",
            storageBucket: "coletor-92990.firebasestorage.app", messagingSenderId: "591970302569",
            appId: "1:591970302569:web:edcf8e8c6f55729c9340f8", measurementId: "G-QJQNMDCHW5"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let escalaEditId = null;

        // --- FUN√á√ïES DE GERENCIAMENTO DE ESCALAS (Vers√£o mais recente) ---

        function salvarEscala() {
            const inicio = document.getElementById('inicio').value;
            const fim = document.getElementById('fim').value;
            if (!inicio || !fim) { alert("Os campos In√≠cio e Fim s√£o obrigat√≥rios."); return; }
            if (fim <= inicio) { alert("O hor√°rio FIM deve ser maior que o hor√°rio IN√çCIO."); return; }
            const publicadores = ["p1", "p2", "p3"].map(id => document.getElementById(id).value).filter(Boolean).map(nome => ({ nome: nome, status: 'amarelo' }));
            if (publicadores.length === 0) { alert("Adicione pelo menos um publicador."); return; }
            const dados = {
                ponto: document.getElementById('ponto').value, equipamento: document.getElementById('equipamento').value,
                publicadores: publicadores, inicio, fim
            };

            if (escalaEditId) {
                db.ref('escalas/' + escalaEditId).once('value', (snapshot) => {
                    const publicadoresAntigos = snapshot.val().publicadores || [];
                    dados.publicadores = dados.publicadores.map(novoPub => {
                        const pubAntigo = publicadoresAntigos.find(p => p.nome === novoPub.nome);
                        return pubAntigo ? pubAntigo : novoPub;
                    });
                    db.ref('escalas/' + escalaEditId).update(dados).then(() => {
                        alert("Escala atualizada com sucesso!");
                        cancelarEdicao();
                    });
                });
            } else {
                db.ref('escalas').push(dados).then(() => {
                    alert("Escala salva com sucesso!");
                    cancelarEdicao();
                });
            }
        }

        function listarEscalas() {
            const filtroNome = (document.getElementById("filtro")?.value || "").toLowerCase();
            const filtroPonto = (document.getElementById("filtroPonto")?.value || "").toLowerCase();
            const filtroData = document.getElementById("filtroData")?.value || "";
            const tbody = document.getElementById("lista-escalas");
            tbody.innerHTML = "<tr><td colspan='6'>Carregando...</td></tr>";

            db.ref('escalas').orderByChild('inicio').once('value').then(snapshot => {
                tbody.innerHTML = "";
                let count = 0;
                const escalasArray = [];
                snapshot.forEach(child => escalasArray.push({ key: child.key, ...child.val() }));

                escalasArray.reverse().forEach(esc => {
                    const nomeMatch = filtroNome ? (esc.publicadores || []).some(p => p.nome.toLowerCase().includes(filtroNome)) : true;
                    const pontoMatch = filtroPonto ? (esc.ponto || "").toLowerCase().includes(filtroPonto) : true;
                    const dataMatch = filtroData ? (esc.inicio || '').startsWith(filtroData) : true;
                    if (!nomeMatch || !pontoMatch || !dataMatch) return;
                    count++;
                    const row = document.createElement("tr");
                    const confirmacoes = (esc.publicadores || []).map(p => `
                        <div><span>${p.nome}</span>
                        <span class="confirm-btns">
                            <button class="verde ${p.status === 'verde' ? 'active' : ''}" title="Confirmado" onclick="atualizarStatus('${esc.key}', '${p.nome}', 'verde')">‚úî</button>
                            <button class="amarelo ${p.status === 'amarelo' ? 'active' : ''}" title="Talvez" onclick="atualizarStatus('${esc.key}', '${p.nome}', 'amarelo')">?</button>
                            <button class="vermelho ${p.status === 'vermelho' ? 'active' : ''}" title="N√£o ir√°" onclick="atualizarStatus('${esc.key}', '${p.nome}', 'vermelho')">‚úñ</button>
                        </span></div>`).join('');
                    row.innerHTML = `
                        <td>${esc.ponto}</td><td>${esc.equipamento}</td>
                        <td><div class="status-container">${confirmacoes}</div></td>
                        <td>${new Date(esc.inicio).toLocaleString('pt-BR', {dateStyle:'short', timeStyle:'short'})}</td>
                        <td>${new Date(esc.fim).toLocaleString('pt-BR', {dateStyle:'short', timeStyle:'short'})}</td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="iniciarEdicao('${esc.key}')">Alterar</button>
                            <button class="btn btn-sm btn-danger" onclick="excluirEntrada('escalas','${esc.key}', listarEscalas)">Excluir</button>
                        </td>`;
                    tbody.appendChild(row);
                });
                if(count === 0) tbody.innerHTML = "<tr><td colspan='6'>Nenhuma escala encontrada.</td></tr>";
            });
        }
        
        function atualizarStatus(escalaId, publicadorNome, novoStatus) {
            const ref = db.ref(`escalas/${escalaId}/publicadores`);
            ref.once('value').then(snapshot => {
                const publicadores = snapshot.val() || [];
                const pubIndex = publicadores.findIndex(p => p.nome === publicadorNome);
                if (pubIndex !== -1) {
                    publicadores[pubIndex].status = novoStatus;
                    ref.set(publicadores).then(listarEscalas);
                }
            });
        }
        
        function iniciarEdicao(id) {
            escalaEditId = id;
            db.ref('escalas/' + id).once('value').then(snapshot => {
                const esc = snapshot.val();
                if (!esc) return;
                document.getElementById('ponto').value = esc.ponto;
                document.getElementById('equipamento').value = esc.equipamento;
                document.getElementById('inicio').value = esc.inicio;
                document.getElementById('fim').value = esc.fim;
                ['p1', 'p2', 'p3'].forEach(pid => document.getElementById(pid).value = "");
                (esc.publicadores || []).forEach((p, i) => { if (i < 3) document.getElementById(`p${i + 1}`).value = p.nome; });
                document.getElementById('form-title').textContent = "Alterar Escala";
                document.getElementById('saveButton').textContent = "Atualizar Escala";
                document.getElementById('cancelButton').style.display = 'inline-block';
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        }

        function cancelarEdicao() {
            escalaEditId = null;
            document.getElementById('form-escala').reset();
            document.getElementById('form-title').textContent = "Nova Escala";
            document.getElementById('saveButton').textContent = "Salvar Escala";
            document.getElementById('cancelButton').style.display = 'none';
            listarEscalas();
        }

        // --- FUN√á√ïES DE MANUTEN√á√ÉO DE TABELAS (Restauradas) ---

        function adicionarSimples(caminho, inputId) {
            const input = document.getElementById(inputId);
            const valor = input.value;
            if (!valor) return;
            const campo = caminho === 'Pontos' ? "Nome do ponto" : caminho === 'Equipamentos' ? "Equipamentos" : "Publicador";
            const dados = { [campo]: valor };
            
            db.ref(caminho).push(dados).then(() => {
                input.value = "";
                const tbodyId = `tabela-${caminho.toLowerCase()}`;
                listarTabela(caminho, campo, tbodyId);
                initSelects();
            });
        }
        
        function listarTabela(caminho, campo, tbodyId) {
            const tbody = document.getElementById(tbodyId);
            tbody.innerHTML = "";
            db.ref(caminho).once('value').then(snapshot => {
                snapshot.forEach(child => {
                    const val = child.val();
                    const nome = val[campo] || "Sem nome";
                    const inputId = `${tbodyId}_${child.key}`;
                    const tr = document.createElement("tr");
                    const callback = () => { listarTabela(caminho, campo, tbodyId); initSelects(); };
                    tr.innerHTML = `
                        <td><input type="text" id="${inputId}" value="${nome}"></td>
                        <td>
                            <button class="btn btn-sm btn-success" onclick="atualizarEntrada('${caminho}', '${child.key}', {'${campo}': document.getElementById('${inputId}').value}, () => listarTabela('${caminho}', '${campo}', '${tbodyId}'))">Salvar</button>
                            <button class="btn btn-sm btn-danger" onclick="excluirEntrada('${caminho}', '${child.key}', callback)">Excluir</button>
                        </td>`;
                    tbody.appendChild(tr);
                });
            });
        }
        
        function atualizarEntrada(caminho, id, dados, callback) {
            db.ref(`${caminho}/${id}`).update(dados).then(callback);
        }

        // --- FUN√á√ïES UTILIT√ÅRIAS (Unificadas) ---
        
        // ‚ú® TORNADA GEN√âRICA PARA ACEITAR UM CALLBACK DE SUCESSO
        function excluirEntrada(caminho, id, callback) {
            if (confirm("Tem certeza que deseja excluir este item?")) {
                db.ref(`${caminho}/${id}`).remove().then(() => {
                    if (callback) callback();
                });
            }
        }
        
        function carregarOpcoes(caminho, selectId) {
            const select = document.getElementById(selectId);
            if (!select) return;
            db.ref(caminho).once('value').then(snapshot => {
                const currentValue = select.value;
                select.innerHTML = '<option value="">Selecione</option>';
                snapshot.forEach(child => {
                    const val = child.val();
                    // L√≥gica restaurada para pegar o nome correto de qualquer tabela
                    let texto = val["Nome do ponto"] || val.Publicador || val.Equipamentos || "Sem nome";
                    const option = new Option(texto, texto);
                    select.add(option);
                });
                select.value = currentValue;
            });
        }

        function initSelects() {
            ["p1", "p2", "p3"].forEach(id => carregarOpcoes('Publicadores', id));
            carregarOpcoes('Pontos', 'ponto');
            carregarOpcoes('Equipamentos', 'equipamento');
        }

        window.onload = () => {
            initSelects();
            listarEscalas();
            // Chamadas restauradas para listar os dados de manuten√ß√£o
            listarTabela('Publicadores', 'Publicador', 'tabela-publicadores');
            listarTabela('Equipamentos', 'Equipamentos', 'tabela-equipamentos');
            listarTabela('Pontos', 'Nome do ponto', 'tabela-pontos');
        };
    </script>
</body>
</html>
